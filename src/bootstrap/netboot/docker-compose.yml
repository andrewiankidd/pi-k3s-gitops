version: "2.1"
services:
  pi-tftp:
    image: pghalliday/tftp
    # depends_on:
    #   - builder
    container_name: pi-tftp
    network_mode: host
    volumes:
      - ./README.md:/var/tftpboot/test.txt:ro
      - netboot-boot-data:/var/tftpboot
    healthcheck:
      test: ["CMD", "test", "-f", "/var/tftpboot/test.txt"]
      interval: 1m
      timeout: 5s
      retries: 0
      start_period: 1m
    ports:
      - 69:69/udp
    restart: unless-stopped
  pi-nfs:
    image: erichough/nfs-server
    # depends_on:
    #   - builder
    container_name: pi-nfs
    privileged: true
    environment:
      - NFS_VERSION=3
      - NFS_EXPORT_0=/mnt/nfsshare *(rw,fsid=0,async,no_subtree_check,no_auth_nlm,insecure,no_root_squash)
      - NFS_LOG_LEVEL=DEBUG
    volumes:
      - netboot-os-data:/mnt/nfsshare
    ports:
      # - 111:111
      # - 111:111/udp
      - 2049:2049
      - 2049:2049/udp
      - 32765-32768:32765-32768
      - 32765-32768:32765-32768/udp
    restart: unless-stopped
  # builder:
  #   container_name: builder
  #   build:
  #     dockerfile: builder.Dockerfile
  #     network: host
  #   depends_on:
  #     nixos-sd-image:
  #       condition: service_healthy
  #   privileged: true
  #   environment:
  #     # RaspiOS Min
  #     # - DOWNLOAD_LINK=https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2023-12-11/2023-12-11-raspios-bookworm-arm64-lite.img.xz
  #     # RaspiOS
  #     # - DOWNLOAD_LINK=https://downloads.raspberrypi.com/raspios_arm64/images/raspios_arm64-2023-12-06/2023-12-05-raspios-bookworm-arm64.img.xz
  #     # RaspiOS Full
  #     # - DOWNLOAD_LINK=https://downloads.raspberrypi.com/raspios_full_arm64/images/raspios_full_arm64-2023-12-06/2023-12-05-raspios-bookworm-arm64-full.img.xz
  #     # NixOS
  #     - DOWNLOAD_LINK=file://mnt/netboot/download/nixos-sd-image-24.05.20241006.ecbc1ca-aarch64-linux.img.zst
  #     - CLEAN_BOOT_FILES=true
  #     # - CLEAN_OS_FILES=true
  #   volumes:
  #     - .:/mnt/netboot
  #     - netboot-boot-data:/mnt/netboot/boot
  #     - netboot-os-data:/mnt/netboot/os
  nixos-sd-image:
    container_name: nixos-sd-image
    image: nixos/nix:2.25.3
    # platform: linux/arm64
    # security_opt:
    #   - seccomp=unconfined  # Disables seccomp profile
    privileged: true
    command: bash /mnt/netboot/scripts/build-nix.sh
    # healthcheck:
    #   test: ["CMD", "test", "-f", "/mnt/netboot/.nix_ready"]
    #   interval: 1m
    #   timeout: 3s
    #   retries: 30
    #   start_period: 5m
    volumes:
      - .:/mnt/netboot
      - netboot-boot-data:/mnt/netboot/boot
      - netboot-os-data:/mnt/netboot/os
volumes:
  netboot-boot-data:
  netboot-os-data: